<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lab 4: Group Scores - Gas Absorption</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon (uses ct_logo.png) -->
  <link rel="icon" type="image/png" href="./ct_logo.png" />
  <link rel="shortcut icon" type="image/png" href="./ct_logo.png" />

  <!-- Tailwind for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          screens: {
            'xs': '475px',
          }
        }
      }
    }
  </script>
  <!-- Google Fonts - Sukhumvit for Thai characters -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sukhumvit+Set:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    .thai-font {
      font-family: 'Sukhumvit Set', 'Noto Sans Thai', 'Thonburi', 'Loma', 'Garuda', sans-serif;
    }
  </style>
  <!-- Papa Parse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-36N5TW5XXL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-36N5TW5XXL');
</script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Header with responsive logo + titles -->
  <header class="max-w-6xl mx-auto p-4 sm:p-6 pt-6 sm:pt-8">
    <div class="flex flex-col items-center gap-3 sm:gap-4">
      <!-- Logo wrapper centered for all screen sizes -->
      <div class="flex items-center justify-center">
        <img
          src="./ct_logo.png"
          alt="Department of Chemical Technology, Faculty of Science, Chulalongkorn University logo"
          class="h-16 w-auto object-contain sm:h-20 md:h-24 lg:h-28"
        />
      </div>

      <!-- Title and subtitle -->
      <div class="text-center flex-1">
        <h1 class="text-base sm:text-lg md:text-2xl font-semibold text-gray-900 leading-tight">
          Department of Chemical Technology, Faculty of Science, Chulalongkorn University
        </h1>
        <p class="text-xs sm:text-sm md:text-base text-gray-600 mt-1">
          2306452 Unit Operations Laboratory II : Lab 4 Gas Absorption
        </p>
        <p class="text-xs sm:text-sm md:text-base text-gray-900 font-semibold mt-1">
          Instructor: Asst. Prof. Dr. Pichaya In-na
          <br class="hidden sm:block" />
          <span class="sm:hidden"> | </span>
          TA: Mr. Kantaphan Punnaanan
        </p>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 sm:p-6">
    <!-- Back button -->
    <div class="mb-4">
      <button id="back-btn" class="px-3 py-2 text-xs sm:text-sm bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" aria-label="Return to main status page">
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          <span class="hidden xs:inline">Back to Status</span>
          <span class="xs:hidden">Back</span>
        </span>
      </button>
    </div>

    <div class="bg-white shadow rounded-xl p-4 sm:p-5">
      <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-blue-700 mb-4 sm:mb-6">Group Score Access</h2>

      <!-- Authentication Section -->
      <div id="auth-section" class="mb-4 sm:mb-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
          <h3 class="text-base sm:text-lg font-semibold text-blue-800 mb-3 sm:mb-4">Access Group Scores</h3>
          
          <div class="space-y-3 sm:space-y-4">
            <div>
              <label for="student-id" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                Student ID
              </label>
              <input 
                type="text" 
                id="student-id" 
                name="studentId"
                placeholder="653XXXXXXX"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors duration-200"
                pattern="653[0-9]{7}"
                title="Please enter a valid student ID in format: 653XXXXXXX"
                aria-describedby="id-help"
                autocomplete="off"
                required
              />
              <p id="id-help" class="text-xs text-gray-500 mt-1">Format: 653XXXXXXX (where X is any digit)</p>
            </div>
            
            <div>
              <label for="group-select" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                Group Selection
              </label>
              <select 
                id="group-select" 
                name="group"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors duration-200"
                aria-describedby="group-help"
                required
              >
                <option value="">Select your group...</option>
                <option value="1">Group 1</option>
                <option value="2">Group 2</option>
                <option value="3">Group 3</option>
                <option value="4">Group 4</option>
                <option value="5">Group 5</option>
                <option value="6">Group 6</option>
                <option value="7">Group 7</option>
                <option value="8">Group 8</option>
                <option value="9">Group 9</option>
                <option value="10">Group 10</option>
              </select>
              <p id="group-help" class="text-xs text-gray-500 mt-1">Select the group number that matches your student ID</p>
            </div>
            
          </div>
          
          <div class="mt-3 sm:mt-4 space-y-3">
            <!-- Step 1: Request Access Code -->
            <div>
              <button id="request-code-btn" class="w-full px-3 sm:px-4 py-2 text-sm sm:text-base bg-purple-600 hover:bg-purple-700 text-white rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2" aria-describedby="request-help">
                <span class="flex items-center justify-center gap-1">
                  <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                  </svg>
                  Step 1: Request Access Code
                </span>
              </button>
              <p id="request-help" class="text-xs text-gray-500 mt-1 text-center">Request a temporary access code after verifying your student ID and group</p>
            </div>
            
            <!-- Step 2: Access Code Input (initially hidden) -->
            <div id="access-code-section" class="hidden">
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                <label for="access-code-input" class="block text-xs sm:text-sm font-medium text-purple-800 mb-2">
                  Step 2: Enter Your Access Code
                </label>
                <div class="flex flex-col sm:flex-row gap-2">
                  <input 
                    type="text" 
                    id="access-code-input" 
                    class="flex-1 px-3 py-2 text-sm border border-purple-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent font-mono transition-colors duration-200"
                    placeholder="Enter 8-character access code..."
                    maxlength="8"
                    aria-describedby="code-help"
                    autocomplete="off"
                    spellcheck="false"
                  />
                  <button id="access-btn" class="px-3 sm:px-4 py-2 text-sm sm:text-base bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" aria-describedby="access-help">
                    <span class="flex items-center gap-1">
                      <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      Step 3: Access Scores
                    </span>
                  </button>
                </div>
                <p id="code-help" class="text-xs text-purple-600 mt-1">Enter the 8-character access code you received</p>
                <p id="access-help" class="text-xs text-blue-600 mt-1">Click to view your group's scores</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden mb-4 p-3 rounded-md bg-red-50 border border-red-200 text-red-700"></div>

      <!-- Score Display Section -->
      <div id="score-section" class="hidden">
        <div class="bg-green-50 border border-green-200 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
          <h3 class="text-base sm:text-lg font-semibold text-green-800 mb-3 sm:mb-4">Group <span id="selected-group"></span> Scores</h3>
          
          <!-- Student Information -->
          <div class="bg-white rounded-lg p-3 sm:p-4 mb-3 sm:mb-4 border border-green-300">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div>
                <div class="text-xs sm:text-sm text-gray-600">Student ID:</div>
                <div class="font-mono text-base sm:text-lg font-semibold text-gray-900" id="display-student-id">‚Äî</div>
              </div>
              <div>
                <div class="text-xs sm:text-sm text-gray-600">Name:</div>
                <div class="text-base sm:text-lg font-semibold text-gray-900 thai-font" id="display-student-name">‚Äî</div>
              </div>
            </div>
          </div>
          
          <div id="score-details" class="space-y-2 sm:space-y-3">
            <!-- Score details will be populated here -->
          </div>
          
          <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-green-200">
            <div class="flex justify-between items-center">
              <span class="text-base sm:text-lg font-semibold text-green-800">Total Score:</span>
              <span id="total-score" class="text-lg sm:text-xl font-bold text-green-700">0</span>
            </div>
          </div>
        </div>

        <!-- Individual Performance Analysis -->
        <div id="individual-analysis" class="hidden">
          <!-- Performance Analysis -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 sm:p-4 mb-4 sm:mb-6">
            <h3 class="text-base sm:text-lg font-semibold text-yellow-800 mb-3 sm:mb-4">Performance Analysis</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
              <div class="bg-white rounded-lg p-3 sm:p-4 border border-yellow-300">
                <h4 class="font-semibold text-gray-900 mb-2 sm:mb-3 text-green-700 text-sm sm:text-base">Strengths</h4>
                <ul id="strengths-list" class="text-xs sm:text-sm text-gray-600 space-y-1">
                  <!-- Strengths will be populated by JavaScript -->
                </ul>
              </div>
              <div class="bg-white rounded-lg p-3 sm:p-4 border border-yellow-300">
                <h4 class="font-semibold text-gray-900 mb-2 sm:mb-3 text-orange-700 text-sm sm:text-base">Areas for Improvement</h4>
                <ul id="improvements-list" class="text-xs sm:text-sm text-gray-600 space-y-1">
                  <!-- Areas for improvement will be populated by JavaScript -->
                </ul>
              </div>
            </div>
          </div>

          <!-- Group Comparison -->
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 sm:p-4">
            <h3 class="text-base sm:text-lg font-semibold text-purple-800 mb-3 sm:mb-4">Group Comparison</h3>
            <div class="bg-white rounded-lg p-3 sm:p-4 border border-purple-300">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 text-center">
                <div>
                  <div class="text-base sm:text-lg font-semibold text-gray-900" id="group-rank">‚Äî</div>
                  <div class="text-xs sm:text-sm text-gray-600">Group Rank</div>
                </div>
                <div>
                  <div class="text-base sm:text-lg font-semibold text-gray-900" id="group-average">‚Äî</div>
                  <div class="text-xs sm:text-sm text-gray-600">Group Average</div>
                </div>
                <div>
                  <div class="text-base sm:text-lg font-semibold text-gray-900" id="class-rank">‚Äî</div>
                  <div class="text-xs sm:text-sm text-gray-600">Class Rank</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Update date -->
      <div class="mt-3 sm:mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
        <div class="flex items-center gap-2">
          <svg class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="font-medium text-blue-700 text-xs sm:text-sm">Last updated:</span>
          <span id="update-date" class="text-blue-600 text-xs sm:text-sm">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-xs sm:text-sm text-gray-600 mt-4 sm:mt-6 px-4 sm:px-0">
      <div class="space-y-1 sm:space-y-2">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-0">
          <span>Developed by&nbsp;</span>
          <a href="https://kantaphan.netlify.app/" class="text-blue-700 hover:text-blue-800 hover:underline font-medium" target="_blank" rel="noopener noreferrer">
            Punnaanan K. (KTP)
          </a>
          <span class="hidden sm:inline">@</span>
          <span class="sm:hidden">@</span>
          <a href="https://niab-lab.works/" class="text-blue-700 hover:text-blue-800 hover:underline font-medium" target="_blank" rel="noopener noreferrer">
            NIAB LAB
          </a>
        </div>
        <div class="text-xs text-gray-500 px-2">
          For 2306452 Unit Operations Laboratory II - Lab 4 Gas Absorption
        </div>
        <div class="text-xs text-gray-400 px-2">
          ¬© 2025 Department of Chemical Technology, Faculty of Science, Chulalongkorn University
        </div>
      </div>
    </footer>
  </main>

  <script>
    // Configuration
    const GRADING_CSV_URL = encodeURI('./452-Full Report.csv');
    const GROUP_NAME_CSV_URL = encodeURI('./452-Group-Name.csv');
    const PERFORMANCE_CSV_URL = encodeURI('./452-Performance.csv');
    const ORAL_EXAM_CSV_URL = encodeURI('./452-Oral Exam.csv');
    const PRELAB_CSV_URL = encodeURI('./452-Prelab.csv');
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
    const MAX_RETRIES = 3;
    const RETRY_DELAY = 1000; // 1 second
    
    let gradingData = null;
    let groupNameData = null;
    let performanceData = null;
    let oralExamData = null;
    let prelabData = null;
    let currentAccessCode = null;
    let accessCodeExpiry = null;
    
    // Cache for data
    let dataCache = {
      grading: { data: null, timestamp: 0 },
      groupName: { data: null, timestamp: 0 },
      performance: { data: null, timestamp: 0 },
      oralExam: { data: null, timestamp: 0 },
      prelab: { data: null, timestamp: 0 }
    };

    // DOM elements
    const studentIdInput = document.getElementById('student-id');
    const groupSelect = document.getElementById('group-select');
    const accessCodeInput = document.getElementById('access-code-input');
    const requestCodeBtn = document.getElementById('request-code-btn');
    const accessBtn = document.getElementById('access-btn');
    const backBtn = document.getElementById('back-btn');
    const errorMessage = document.getElementById('error-message');
    const authSection = document.getElementById('auth-section');
    const scoreSection = document.getElementById('score-section');
    const selectedGroupSpan = document.getElementById('selected-group');
    const scoreDetails = document.getElementById('score-details');
    const totalScoreSpan = document.getElementById('total-score');
    const updateDateSpan = document.getElementById('update-date');
    
    // New DOM elements for enhanced features
    const displayStudentId = document.getElementById('display-student-id');
    const displayStudentName = document.getElementById('display-student-name');
    const individualAnalysis = document.getElementById('individual-analysis');
    const strengthsList = document.getElementById('strengths-list');
    const improvementsList = document.getElementById('improvements-list');
    const groupRank = document.getElementById('group-rank');
    const groupAverage = document.getElementById('group-average');
    const classRank = document.getElementById('class-rank');

    // Event listeners
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    requestCodeBtn.addEventListener('click', handleRequestAccessCode);
    accessBtn.addEventListener('click', handleAccessScores);
    
    accessCodeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleAccessScores();
      }
    });

    // Event delegation for copy button (works with dynamically created elements)
    document.addEventListener('click', (e) => {
      // Check if the clicked element is the copy button or a child of it
      const copyBtn = e.target.closest('#copy-code-btn');
      if (copyBtn) {
        e.preventDefault();
        e.stopPropagation();
        // Find the access code from the display element
        const accessCodeDisplay = document.getElementById('access-code-display');
        if (accessCodeDisplay) {
          const code = accessCodeDisplay.textContent.trim();
          copyAccessCode(code, copyBtn);
        }
      }
    });

    async function fetchCsvText(url, retryCount = 0) {
      try {
        const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
        const res = await fetch(url + bust, { 
          cache: 'no-store',
          headers: {
            'Accept': 'text/csv,text/plain,*/*',
            'Cache-Control': 'no-cache'
          }
        });
        
        if (!res.ok) {
          throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
        }
        
        // Return both text and last-modified header
        const text = await res.text();
        const lastModified = res.headers.get('last-modified');
        return { text, lastModified };
      } catch (error) {
        if (retryCount < MAX_RETRIES) {
          console.warn(`Fetch attempt ${retryCount + 1} failed, retrying in ${RETRY_DELAY}ms...`, error.message);
          await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * (retryCount + 1)));
          return fetchCsvText(url, retryCount + 1);
        }
        throw error;
      }
    }


    async function loadGradingData(forceRefresh = false) {
      try {
        const now = Date.now();
        
        // Check cache first
        if (!forceRefresh && dataCache.grading.data && (now - dataCache.grading.timestamp) < CACHE_DURATION) {
          console.log('Using cached grading data');
          gradingData = dataCache.grading.data;
          updateDateSpan.textContent = new Date(dataCache.grading.timestamp).toLocaleString();
          return;
        }

        const result = await fetchCsvText(GRADING_CSV_URL);
        // Remove BOM character if present
        const cleanText = result.text.replace(/^\uFEFF/, '');
        const parsed = Papa.parse(cleanText, { header: true, skipEmptyLines: true });
        gradingData = parsed.data || [];
        
        // Use last-modified time from CSV file, fallback to current time
        const csvLastModified = result.lastModified ? new Date(result.lastModified) : new Date();
        
        // Update cache
        dataCache.grading = {
          data: gradingData,
          timestamp: csvLastModified.getTime()
        };
        
        updateDateSpan.textContent = csvLastModified.toLocaleString();
        
      } catch (error) {
        console.error('Error loading grading data:', error);
        showError('Failed to load grading data. Please try again.');
      }
    }

    async function loadGroupNameData(forceRefresh = false) {
      try {
        const now = Date.now();
        
        // Check cache first
        if (!forceRefresh && dataCache.groupName.data && (now - dataCache.groupName.timestamp) < CACHE_DURATION) {
          console.log('Using cached group name data');
          groupNameData = dataCache.groupName.data;
          return;
        }

        const result = await fetchCsvText(GROUP_NAME_CSV_URL);
        // Remove BOM character if present
        const cleanText = result.text.replace(/^\uFEFF/, '');
        const parsed = Papa.parse(cleanText, { header: true, skipEmptyLines: true });
        groupNameData = parsed.data || [];
        
        // Use last-modified time from CSV file, fallback to current time
        const csvLastModified = result.lastModified ? new Date(result.lastModified) : new Date();
        
        // Update cache
        dataCache.groupName = {
          data: groupNameData,
          timestamp: csvLastModified.getTime()
        };
        
      } catch (error) {
        console.error('Error loading group name data:', error);
        showError('Failed to load group name data. Please try again.');
      }
    }

    async function loadPerformanceData(forceRefresh = false) {
      try {
        const now = Date.now();
        
        // Check cache first
        if (!forceRefresh && dataCache.performance.data && (now - dataCache.performance.timestamp) < CACHE_DURATION) {
          console.log('Using cached performance data');
          performanceData = dataCache.performance.data;
          return;
        }

        const result = await fetchCsvText(PERFORMANCE_CSV_URL);
        // Remove BOM character if present
        const cleanText = result.text.replace(/^\uFEFF/, '');
        const parsed = Papa.parse(cleanText, { header: true, skipEmptyLines: true });
        performanceData = parsed.data || [];
        
        // Use last-modified time from CSV file, fallback to current time
        const csvLastModified = result.lastModified ? new Date(result.lastModified) : new Date();
        
        // Update cache
        dataCache.performance = {
          data: performanceData,
          timestamp: csvLastModified.getTime()
        };
        
      } catch (error) {
        console.error('Error loading performance data:', error);
        showError('Failed to load performance data. Please try again.');
      }
    }

    async function loadOralExamData(forceRefresh = false) {
      try {
        const now = Date.now();
        
        // Check cache first
        if (!forceRefresh && dataCache.oralExam.data && (now - dataCache.oralExam.timestamp) < CACHE_DURATION) {
          console.log('Using cached oral exam data');
          oralExamData = dataCache.oralExam.data;
          return;
        }

        const result = await fetchCsvText(ORAL_EXAM_CSV_URL);
        // Remove BOM character if present
        const cleanText = result.text.replace(/^\uFEFF/, '');
        const parsed = Papa.parse(cleanText, { header: true, skipEmptyLines: true });
        oralExamData = parsed.data || [];
        
        // Use last-modified time from CSV file, fallback to current time
        const csvLastModified = result.lastModified ? new Date(result.lastModified) : new Date();
        
        // Update cache
        dataCache.oralExam = {
          data: oralExamData,
          timestamp: csvLastModified.getTime()
        };
        
      } catch (error) {
        console.error('Error loading oral exam data:', error);
        showError('Failed to load oral exam data. Please try again.');
      }
    }

    async function loadPrelabData(forceRefresh = false) {
      try {
        const now = Date.now();
        
        // Check cache first
        if (!forceRefresh && dataCache.prelab.data && (now - dataCache.prelab.timestamp) < CACHE_DURATION) {
          console.log('Using cached prelab data');
          prelabData = dataCache.prelab.data;
          return;
        }

        const result = await fetchCsvText(PRELAB_CSV_URL);
        // Remove BOM character if present
        const cleanText = result.text.replace(/^\uFEFF/, '');
        const parsed = Papa.parse(cleanText, { header: true, skipEmptyLines: true });
        prelabData = parsed.data || [];
        
        // Use last-modified time from CSV file, fallback to current time
        const csvLastModified = result.lastModified ? new Date(result.lastModified) : new Date();
        
        // Update cache
        dataCache.prelab = {
          data: prelabData,
          timestamp: csvLastModified.getTime()
        };
        
      } catch (error) {
        console.error('Error loading prelab data:', error);
        showError('Failed to load prelab data. Please try again.');
      }
    }

    // Validate student ID format
    function validateStudentIdFormat(studentId) {
      const pattern = /^653[0-9]{7}$/;
      return pattern.test(studentId);
    }

    // Find group and name for student ID using actual group-name data
    function findStudentInfo(studentId) {
      if (!groupNameData || groupNameData.length === 0) {
        console.warn('Group name data not loaded yet');
        return null;
      }
      
      // Find the student in the group-name data
      const student = groupNameData.find(row => row.ID === studentId);
      if (student) {
        return { 
          group: student.Group, 
          name: student.Name 
        };
      }
      
      return null;
    }

    // Get individual scores for a student (synced from admin.html)
    function getIndividualScores(studentId, groupNumber) {
      let performanceScore = 0;
      let oralExamScore = 0;
      let prelabScore = 0;
      let groupReportScore = 0;

      // Get performance score (matching admin.html logic)
      if (performanceData && performanceData.length > 0) {
        const performanceRow = performanceData.find(row => row.ID === studentId);
        if (performanceRow && performanceRow['Total (10)']) {
          performanceScore = parseFloat(performanceRow['Total (10)']) || 0;
        }
      }

      // Get oral exam score (matching admin.html logic)
      if (oralExamData && oralExamData.length > 0) {
        const oralExamRow = oralExamData.find(row => row.ID === studentId);
        if (oralExamRow && oralExamRow['Oral Exam (20)']) {
          oralExamScore = parseFloat(oralExamRow['Oral Exam (20)']) || 0;
        }
      }

      // Get prelab score (matching admin.html logic)
      if (prelabData && prelabData.length > 0) {
        const prelabRow = prelabData.find(row => row.ID === studentId);
        if (prelabRow && prelabRow['Total (20)']) {
          prelabScore = parseFloat(prelabRow['Total (20)']) || 0;
        }
      }

      // Get group report score from grading data (matching admin.html logic)
      if (gradingData && gradingData.length > 0) {
        let groupTotalScore = 0;
        gradingData.forEach(row => {
          // The first column contains the category name
          const category = row.Group || Object.keys(row)[0];
          const score = parseFloat(row[groupNumber]) || 0;
          if (category && category !== 'Total Score' && category !== 'Group') {
            groupTotalScore += score;
          }
        });
        groupReportScore = groupTotalScore;
      }

      // Calculate total individual score (Performance + Oral Exam + Prelab + Group Report)
      const totalIndividualScore = performanceScore + oralExamScore + prelabScore + groupReportScore;

      return {
        performanceScore,
        oralExamScore,
        prelabScore,
        groupReportScore,
        totalIndividualScore
      };
    }

    // Get group statistics for comparison (synced from admin.html)
    function getGroupStatistics(studentId, groupNumber, studentScores) {
      // Build comprehensive student data structure similar to admin.html
      const studentsByGroup = {};
      const allStudents = [];
      
      // Process all students to build the same data structure as admin.html
      if (groupNameData && groupNameData.length > 0) {
        groupNameData.forEach(row => {
          const group = row.Group;
          const studentId = row.ID;
          const name = row.Name;
          if (group && studentId && name) {
            if (!studentsByGroup[group]) {
              studentsByGroup[group] = [];
            }
            
            // Get individual scores for this student
            const individualScores = getIndividualScores(studentId, group);
            
            const studentData = {
              studentId: studentId,
              name: name,
              performanceScore: individualScores.performanceScore,
              oralExamScore: individualScores.oralExamScore,
              prelabScore: individualScores.prelabScore,
              groupReportScore: individualScores.groupReportScore,
              totalIndividualScore: individualScores.totalIndividualScore,
              hasScore: individualScores.totalIndividualScore > 0
            };
            
            studentsByGroup[group].push(studentData);
            allStudents.push(studentData);
          }
        });
      }
      
      // Calculate group statistics using only group report scores (full report scores)
      const groupStudents = studentsByGroup[groupNumber] || [];
      const groupReportScoresList = groupStudents.map(s => s.groupReportScore).filter(s => s > 0);
      const groupAverage = groupReportScoresList.length > 0 ? 
        (groupReportScoresList.reduce((a, b) => a + b, 0) / groupReportScoresList.length).toFixed(1) : '0';
      
      // Calculate group rank - compare this group's report score against other groups
      const groupReportScores = {}; // groupNumber -> groupReportScore
      Object.keys(studentsByGroup).forEach(group => {
        const students = studentsByGroup[group];
        if (students.length > 0) {
          // Get the group report score (should be same for all students in the group)
          const groupReportScore = students[0].groupReportScore;
          if (groupReportScore > 0) {
            groupReportScores[group] = groupReportScore;
          }
        }
      });
      
      // Sort groups by their report scores (descending)
      const sortedGroups = Object.entries(groupReportScores)
        .sort(([,a], [,b]) => b - a)
        .map(([group]) => group);
      
      // Find the rank of the current group
      const groupRankValue = sortedGroups.indexOf(groupNumber.toString()) + 1;
      
      // Calculate class rank
      const allScores = allStudents.map(s => s.totalIndividualScore).filter(s => s > 0).sort((a, b) => b - a);
      const classRankValue = allScores.indexOf(studentScores.totalIndividualScore) + 1;
      
      return {
        groupAverage: groupAverage,
        groupRank: groupRankValue > 0 ? `#${groupRankValue}` : '‚Äî',
        classRank: classRankValue > 0 ? `#${classRankValue}` : '‚Äî'
      };
    }

    // Generate performance analysis (synced from admin.html)
    function generatePerformanceAnalysis(studentScores) {
      const strengths = [];
      const improvements = [];

      // Analyze performance
      if (studentScores.performanceScore >= 8) {
        strengths.push('Strong lab performance and participation');
      } else if (studentScores.performanceScore < 5) {
        improvements.push('Improve lab participation and engagement');
      }

      if (studentScores.prelabScore >= 16) {
        strengths.push('Excellent pre-laboratory preparation');
      } else if (studentScores.prelabScore < 10) {
        improvements.push('Enhance pre-laboratory preparation');
      }

      if (studentScores.groupReportScore >= 16) {
        strengths.push('Strong group collaboration and report quality');
      } else if (studentScores.groupReportScore < 10) {
        improvements.push('Improve group report contribution');
      }

      if (studentScores.oralExamScore >= 16) {
        strengths.push('Excellent oral communication skills');
      } else if (studentScores.oralExamScore < 10) {
        improvements.push('Develop oral presentation skills');
      }

      // Overall analysis
      const totalPercentage = Math.round((studentScores.totalIndividualScore / 70) * 100);
      if (totalPercentage >= 80) {
        strengths.push('Overall excellent performance');
      } else if (totalPercentage < 60) {
        improvements.push('Focus on overall performance improvement');
      }

      return { strengths, improvements };
    }


    // Human verification function with retry mechanism
    function showHumanVerification(callback, retryCount = 0) {
      const MAX_RETRIES = 3;
      
      const verificationNumbers = [];
      
      // Generate 3 random numbers between 1-9
      for (let i = 0; i < 3; i++) {
        verificationNumbers.push(Math.floor(Math.random() * 9) + 1);
      }
      
      const numbersText = verificationNumbers.join(' + ');
      const correctAnswer = verificationNumbers.reduce((sum, num) => sum + num, 0);
      
      const retryMessage = retryCount > 0 ? `\n(Attempt ${retryCount + 1} of ${MAX_RETRIES})` : '';
      const userAnswer = prompt(`Human Verification Required${retryMessage}\n\nPlease solve this math problem to prove you are human:\n\n${numbersText} = ?`);
      
      if (userAnswer === null) {
        showError('Verification cancelled. Please try again.');
        return false;
      }
      
      if (parseInt(userAnswer) === correctAnswer) {
        showError('Verification successful! Generating access code...');
        setTimeout(callback, 1000);
        return true;
      } else {
        // Check if we can retry
        if (retryCount < MAX_RETRIES - 1) {
          showError(`Verification failed. ${MAX_RETRIES - retryCount - 1} attempt(s) remaining. Please try again.`);
          // Show a retry button instead of infinite loop
          showRetryVerificationButton(callback, retryCount + 1);
          return false;
        } else {
          showError('Verification failed after maximum attempts. Please refresh the page and try again.');
          return false;
        }
      }
    }

    // Show retry verification button
    function showRetryVerificationButton(callback, retryCount) {
      const resultDiv = document.getElementById('error-message');
      resultDiv.classList.remove('hidden');
      resultDiv.className = 'mb-4 p-4 rounded-md bg-yellow-50 border border-yellow-200 text-yellow-800';
      
      resultDiv.innerHTML = `
        <div class="text-center">
          <h4 class="font-bold text-lg mb-2">‚ö†Ô∏è Verification Failed</h4>
          <p class="mb-3">Please verify you are human to continue.</p>
          <button id="retry-verification-btn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Try Verification Again
            </span>
          </button>
        </div>
      `;
      
      // Add event listener for retry button
      const retryBtn = document.getElementById('retry-verification-btn');
      retryBtn.addEventListener('click', () => {
        hideError();
        showHumanVerification(callback, retryCount);
      });
    }

    // Generate access code
    function generateAccessCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Show access code with 1-minute timer
    function showAccessCode(studentId, group, studentName) {
      const accessCode = generateAccessCode();
      let timeLeft = 60;
      
      // Store the access code and expiry time
      currentAccessCode = accessCode;
      accessCodeExpiry = Date.now() + (60 * 1000); // 1 minute from now
      
      const resultDiv = document.getElementById('error-message');
      resultDiv.classList.remove('hidden');
      resultDiv.className = 'mb-4 p-4 rounded-md bg-green-50 border border-green-200 text-green-800';
      
      const updateTimer = () => {
        resultDiv.innerHTML = `
          <div class="text-center">
            <h4 class="font-bold text-lg mb-2">‚úÖ Access Code Generated</h4>
            <p class="mb-3">Student ID: ${studentId}</p>
            <p class="mb-3 thai-font">Name: ${studentName}</p>
            <p class="mb-3">Group: ${group}</p>
            <div class="bg-white p-4 rounded border-2 border-green-300 mb-3">
              <p class="text-sm text-gray-600 mb-2">Your Access Code:</p>
              <div class="flex items-center gap-3">
                <p id="access-code-display" class="text-2xl font-mono font-bold text-green-800 flex-1 text-center bg-gray-50 px-3 py-2 rounded border">${accessCode}</p>
                <button id="copy-code-btn" class="px-4 py-2 text-sm bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 shadow-sm" aria-label="Copy access code to clipboard">
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    Copy Code
                  </span>
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2 text-center">üí° Click the "Copy Code" button to copy the access code to your clipboard</p>
            </div>
            <p class="text-sm">‚è∞ This code will expire in ${timeLeft} seconds (${Math.ceil(timeLeft/60)} minute${Math.ceil(timeLeft/60) !== 1 ? 's' : ''})</p>
          </div>
        `;
        
        timeLeft--;
        
        if (timeLeft >= 0) {
          setTimeout(updateTimer, 1000);
        } else {
          resultDiv.innerHTML = `
            <div class="text-center">
              <h4 class="font-bold text-lg mb-2">‚è∞ Access Code Expired</h4>
              <p class="text-gray-600">The access code has expired for security purposes.</p>
              <p class="text-sm mt-2">Please request a new code if needed.</p>
            </div>
          `;
          setTimeout(() => {
            resultDiv.classList.add('hidden');
            currentAccessCode = null;
            accessCodeExpiry = null;
          }, 3000);
        }
      };
      
      updateTimer();
      
      // Copy functionality is handled by event delegation in the main event listener below
    }

    // Copy access code to clipboard
    async function copyAccessCode(code, button) {
      console.log('Copy button clicked, code:', code); // Debug log
      
      if (!code || code.length === 0) {
        console.error('No code to copy');
        showError('No access code to copy.');
        return;
      }
      
      // Show loading state
      const originalContent = button.innerHTML;
      button.innerHTML = `
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Copying...
        </span>
      `;
      button.disabled = true;
      
      try {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(code);
          console.log('Successfully copied using clipboard API');
        } else {
          // Fallback for older browsers or non-secure contexts
          throw new Error('Clipboard API not available');
        }
        
        // Show success feedback
        button.innerHTML = `
          <span class="flex items-center gap-1">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Copied!
          </span>
        `;
        button.classList.remove('bg-green-600', 'hover:bg-green-700');
        button.classList.add('bg-green-500');
        
        // Reset button after 2 seconds
        setTimeout(() => {
          button.innerHTML = originalContent;
          button.classList.remove('bg-green-500');
          button.classList.add('bg-green-600', 'hover:bg-green-700');
          button.disabled = false;
        }, 2000);
        
      } catch (err) {
        console.error('Failed to copy access code:', err);
        
        // Fallback for older browsers
        try {
          const textArea = document.createElement('textarea');
          textArea.value = code;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          
          if (successful) {
            console.log('Successfully copied using execCommand');
            
            // Show success feedback
            button.innerHTML = `
              <span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Copied!
              </span>
            `;
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-green-500');
            
            // Reset button after 2 seconds
            setTimeout(() => {
              button.innerHTML = originalContent;
              button.classList.remove('bg-green-500');
              button.classList.add('bg-green-600', 'hover:bg-green-700');
              button.disabled = false;
            }, 2000);
          } else {
            throw new Error('execCommand copy failed');
          }
          
        } catch (fallbackErr) {
          console.error('Fallback copy also failed:', fallbackErr);
          
          // Show error state
          button.innerHTML = `
            <span class="flex items-center gap-1">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Failed
            </span>
          `;
          button.classList.remove('bg-green-600', 'hover:bg-green-700');
          button.classList.add('bg-red-500');
          
          // Show error message
          showError('Failed to copy access code. Please copy it manually: ' + code);
          
          // Reset button after 3 seconds
          setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('bg-red-500');
            button.classList.add('bg-green-600', 'hover:bg-green-700');
            button.disabled = false;
          }, 3000);
        }
      }
    }

    function handleRequestAccessCode() {
      const studentId = studentIdInput.value.trim();
      const selectedGroup = groupSelect.value;
      const requestBtn = document.getElementById('request-code-btn');
      
      // Clear previous errors
      hideError();
      
      // Validation
      if (!studentId) {
        showError('Please enter your student ID.');
        studentIdInput.focus();
        return;
      }
      
      if (!validateStudentIdFormat(studentId)) {
        showError('Invalid student ID format. Please use format: 653XXXXXXX');
        studentIdInput.focus();
        return;
      }
      
      if (!selectedGroup) {
        showError('Please select your group.');
        groupSelect.focus();
        return;
      }
      
      // Check if student ID exists in group data
      const studentInfo = findStudentInfo(studentId);
      if (!studentInfo) {
        showError('Student ID not found in the student database. Please check your student ID.');
        studentIdInput.focus();
        return;
      }
      
      // Check if selected group matches student's group
      if (selectedGroup !== studentInfo.group) {
        showError('The selected group does not match your student ID. Please select the correct group.');
        groupSelect.focus();
        return;
      }
      
      // Disable button and show loading
      requestBtn.disabled = true;
      requestBtn.innerHTML = `
        <span class="flex items-center gap-1">
          <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Verifying...
        </span>
      `;
      
      // Show human verification
      const verificationSuccess = showHumanVerification(() => {
        showAccessCode(studentId, studentInfo.group, studentInfo.name);
        // Show the access code input section
        const accessCodeSection = document.getElementById('access-code-section');
        if (accessCodeSection) {
          accessCodeSection.classList.remove('hidden');
          // Focus on the access code input
          setTimeout(() => {
            const accessCodeInput = document.getElementById('access-code-input');
            if (accessCodeInput) {
              accessCodeInput.focus();
            }
          }, 100);
        }
        // Reset button
        requestBtn.disabled = false;
        requestBtn.innerHTML = `
          <span class="flex items-center justify-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Access Code Generated ‚úì
          </span>
        `;
        requestBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        requestBtn.classList.add('bg-green-600', 'hover:bg-green-700');
      });
      
      // If verification failed immediately (cancelled), reset the button
      if (verificationSuccess === false) {
        // Reset button after a short delay to show the error message first
        setTimeout(() => {
          requestBtn.disabled = false;
          requestBtn.innerHTML = `
            <span class="flex items-center justify-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
              </svg>
              Step 1: Request Access Code
            </span>
          `;
        }, 2000);
      }
    }

    function handleAccessScores() {
      const studentId = studentIdInput.value.trim();
      const selectedGroup = groupSelect.value;
      const accessCode = accessCodeInput.value.trim().toUpperCase();
      const accessBtn = document.getElementById('access-btn');
      
      // Clear previous errors
      hideError();
      
      // Validation
      if (!studentId) {
        showError('Please enter your student ID.');
        studentIdInput.focus();
        return;
      }
      
      if (!validateStudentIdFormat(studentId)) {
        showError('Invalid student ID format. Please use format: 653XXXXXXX');
        studentIdInput.focus();
        return;
      }
      
      if (!selectedGroup) {
        showError('Please select your group.');
        groupSelect.focus();
        return;
      }
      
      if (!accessCode) {
        showError('Please enter your access code.');
        accessCodeInput.focus();
        return;
      }
      
      if (accessCode.length !== 8) {
        showError('Access code must be 8 characters long.');
        accessCodeInput.focus();
        return;
      }
      
      // Check if student ID exists in group data
      const studentInfo = findStudentInfo(studentId);
      if (!studentInfo) {
        showError('Student ID not found in the student database. Please check your student ID.');
        studentIdInput.focus();
        return;
      }
      
      // Check if selected group matches student's group
      if (selectedGroup !== studentInfo.group) {
        showError('The selected group does not match your student ID. Please select the correct group.');
        groupSelect.focus();
        return;
      }
      
      // Check if access code is valid and not expired
      if (!currentAccessCode || !accessCodeExpiry || Date.now() > accessCodeExpiry) {
        showError('No valid access code found. Please request a new access code first.');
        accessCodeInput.focus();
        return;
      }
      
      if (accessCode !== currentAccessCode) {
        showError('Invalid access code. Please check your code and try again.');
        accessCodeInput.focus();
        return;
      }
      
      // Disable button and show loading
      accessBtn.disabled = true;
      accessBtn.innerHTML = `
        <span class="flex items-center gap-1">
          <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Loading...
        </span>
      `;
      
      // Show scores
      displayScores(parseInt(selectedGroup));
      
      // Reset button
      accessBtn.disabled = false;
      accessBtn.innerHTML = `
        <span class="flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Access Scores
        </span>
      `;
    }

    function displayScores(groupNumber) {
      if (!gradingData || gradingData.length === 0) {
        showError('No grading data available.');
        return;
      }
      
      const studentId = studentIdInput.value.trim();
      const studentInfo = findStudentInfo(studentId);
      
      selectedGroupSpan.textContent = groupNumber;
      
      // Display student information
      displayStudentId.textContent = studentId;
      displayStudentName.textContent = studentInfo ? studentInfo.name : 'Unknown';
      
      // Find the group column in the data
      const groupColumn = groupNumber.toString();
      let groupScores = {};
      let totalScore = 0;
      
      // Process each row of grading data
      // Note: The CSV structure has group numbers as column headers and categories in the first column
      gradingData.forEach(row => {
        // The first column contains the category name
        const category = row.Group || Object.keys(row)[0];
        const score = parseFloat(row[groupColumn]) || 0;
        
        if (category && category !== 'Total Score' && category !== 'Group') {
          groupScores[category] = score;
          if (category !== 'Total Score') {
            totalScore += score;
          }
        }
      });
      
      // Display the group scores
      scoreDetails.innerHTML = '';
      Object.entries(groupScores).forEach(([category, score]) => {
        const scoreItem = document.createElement('div');
        scoreItem.className = 'flex justify-between items-center py-2 border-b border-green-200 last:border-b-0';
        scoreItem.innerHTML = `
          <span class="text-gray-700">${category}</span>
          <span class="font-semibold text-green-700">${score}</span>
        `;
        scoreDetails.appendChild(scoreItem);
      });
      
      totalScoreSpan.textContent = totalScore.toFixed(1);
      
      // Get individual scores for the student
      const individualScores = getIndividualScores(studentId, groupNumber);
      
      // Generate and display performance analysis
      const analysis = generatePerformanceAnalysis(individualScores);
      
      // Display strengths
      strengthsList.innerHTML = analysis.strengths.length > 0 ? 
        analysis.strengths.map(s => `<li class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>${s}</li>`).join('') :
        '<li class="text-gray-500 italic">No data available yet</li>';
        
      // Display areas for improvement
      improvementsList.innerHTML = analysis.improvements.length > 0 ? 
        analysis.improvements.map(i => `<li class="flex items-center"><span class="w-2 h-2 bg-orange-500 rounded-full mr-2"></span>${i}</li>`).join('') :
        '<li class="text-gray-500 italic">No areas identified</li>';
      
      // Get and display group comparison data
      const groupStats = getGroupStatistics(studentId, groupNumber, individualScores);
      groupRank.textContent = groupStats.groupRank;
      groupAverage.textContent = groupStats.groupAverage;
      classRank.textContent = groupStats.classRank;
      
      // Show the score section and hide auth section
      authSection.classList.add('hidden');
      scoreSection.classList.remove('hidden');
      individualAnalysis.classList.remove('hidden');
      
      // Clear the access code after successful access
      currentAccessCode = null;
      accessCodeExpiry = null;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }

    function hideError() {
      errorMessage.classList.add('hidden');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + Enter for access scores
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        handleAccessScores();
      }
      
      // Escape to clear form
      if (e.key === 'Escape') {
        studentIdInput.value = '';
        groupSelect.value = '';
        accessCodeInput.value = '';
        hideError();
        studentIdInput.focus();
      }
    });

    // Initialize the page
    async function initializePage() {
      try {
        await Promise.all([
          loadGradingData(),
          loadGroupNameData(),
          loadPerformanceData(),
          loadOralExamData(),
          loadPrelabData()
        ]);
        console.log('Page initialized successfully');
      } catch (error) {
        console.error('Failed to initialize page:', error);
        showError('Failed to load required data. Please refresh the page.');
      }
    }
    
    initializePage();
  </script>
</body>
</html>

